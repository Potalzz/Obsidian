## Task
### 공통
- [ ] 공통 사용되는 것들 공용 함수화
	Entity 생성
	customHoverEffect
	애니메이션(view에서 튀어나오는거)
- [ ] 문서화 주석 추가(model이나 공용 파일)
라이브러리에서 이미지 추가했을 때 확인버튼 누르게 안하고, 효과음 + V 체크표시 아이콘 애니메이션(이미지 중앙에 ?)
- [ ] cached Entity 삭제(바닥밖에 없으니)
- [x] floor 생성 static 변수로 사이즈 제공해서 만들기.
- [x] setupScene에서 room 사이즈 조절하는거 보고 다듬기

### 프로젝트
#### 프로젝트 리스트
- [x] 프로젝트 생성
    - [x] 애니메이션 다시 확인
    - [x] 로직 viewModel로 이동
    - [x] 잡다한 코드 삭제하여 간소화
    - [x] 안쓰는 파일 삭제
    - [x] 폴더 구조 변경
- [x] 프로젝트 삭제
- [x] 프로젝트 리스트 조회
- [x] 프로젝트 이름 수정
- [x] 프로젝트 정렬 변경(좌상단 토글)
- [x] 프로젝트 UI변경(+쉐브론 기능 구현)
- [ ] 데이터 DB에서 불러오면 projectListViewModel 옵셔널로 설정해서 에러 처리나 progressView 만들기

### 공간
#### 공간 생성
- [ ] 공간 생성 삭제
	- [ ] 공간 생성 삭제할 떄 volumeSize 변수로 정해두고 해당 크기로 생성되도록 변경.(현재 상수)


### 초기 Entity
#### 초기 볼륨 객체
- [x] 초기 대지 생성
- [x] 대지(volume) 회전
- [x] 공간 벽 선택적 표시
- [x] immersive 전환
- [x] immersive와 volume 사물 동기화
- [x] 벽면에 배경 추가
      이미지 사이즈에 상관없이 plane 사이즈에 맞게 이미지가 채워짐
- [x] volume 열리면 projectList -> Library 네비게이션 구현
	- [x] Library -> ProjectList 이동하면 volume 닫기
- [x] volume에서 추가할 때 anchorEntity에 추가

#### 벽면에 이미지 교체
Image load하는 함수

`func load(projectName: String, filename: String) throws -> Data`
프로젝트 title, fileName

- [x] 이미지 불러와서 적용 테스트
- [x] 이미지로 머티리얼 입히는 함수 만들기
- [x] 벽면 중앙에 attachment 하기

현재 구조에서 이미지 적용을 진행하려면 ?
- view에서 viewModel 호출
 - 활성화된 프로젝트 찾기


#### 수정 필요
- [ ] window bottom사이즈 조정하는거 현재 상수 -> 실제 window 사이즈 받아오기
- [ ] 현재 방을 가져올 때 rotationAngle을 받아와서 적용하고 있는데, 0도로 rotation을 초기화하는 함수도 포함되어 있음. 나타날 때 rotation을 무조건 0도로 하도록 구현.


## 진행사항
### 작업 진행사항(10/17)
- [x] 회전 잘 안되는 버그 수정하기.
- [x] 가까운 벽면 투명해지고 애니메이션 되도록 구현.
- [x] 벽면 투명화 로직 이해하기
	- [x] volume관련 리팩토링 진행
- [x] projectListViewModel에서 volumeVM관련 로직 plVM으로 옮기기 (activateScene) 삭제는 swiftDB 도입하면 view에서 처리하기(설계상 모델 컨텍스트 주입을 계속 해줘야해서)
- [x] plview에서 view로직 ViewModel로 옮기기
- [x] viewModel 하나씩 사용하게 변경하고, db도입하면 environment로 말고 stateobject로 viewmodel각자 view에서 관리하기

### 회의 때 안건(10/8)
- volume Scene과 Immersive Scene이 서로 연결되어 있어 데이터를 공유해야 함. 아니면 Scene을 Volume과 Immersive 두 개로 나누지 말고, Scene을 하나 만들고 거기서 volume, Immersive 각 상태에 따라 Scene의 데이터를 받아오는 것으로 구현.
- 볼륨에서 에셋 뒤로 밀어 벽쪽에 다가가면 벽면 기울기에 맞춰 기울어지고 당기면 다시 평면으로 되도록 하는 방안도 고려하면 좋을듯

### 프로젝트 생성 관련
- 현재 이름 설정하는 화면이 없음.
- 생성하는 flow를 여러 depth로 설정하는 것이 아니라, 하나의 화면에서 이름 , 공간, 넓이를 한 번에 선택하는 방법 고려.

### customHover관련
wwdc영상 보고 코드 정리해서 블로그에 글 업로드하기.

### 벽면에 이미지 입히기
**이미지 입힌 Entity 생성 과정**
1. 메쉬 생성
2. 텍스쳐 생성(이미지 로드)
3. 머티리얼 생성(텍스쳐 baseColor로입히기)
4. Entity생성(메쉬, 머티리얼 추가)
5. 포지션 및 스케일 설정
6. Entity 루트에 추가


## 개발 기능별
### ~~volume 벽면 제거~~
- [x] 벽면 생성 코드 삭제
- [x] Opacity적용 코드 삭제

### ~~볼륨 Rotation 및 Scale 조절~~
- [x] 볼륨 대지 Builder에서 로테이션 및 스케일 조정하는 방식에서, 추가되기 전에 전체 scale조정하는 방식으로 조절.
- **RealityKit volumetric window entity size limit 1.0 meter constraint visionOS 2025**
- [x] 볼륨 하단 indicator 위치 조정(바닥을 볼륨 영역의 최하단으로 이동 ?)
- [x] 바닥이 content에 추가되는 것이 아니라 anchor에 추가되도록 구현

**어차피 사이즈 받아오는 단계가 사라지는데, volume과 immersive마다 크기를 저장하고 반환해주는 방식이 나을듯 ?**

### ~~UpdatedAt 액션 함수화~~
ProjectRepository에 있는 update를 파일 load할 때 실행되도록 구현.
현재는 직접 호출로 되어있어 추후에 분리하는게 좋을지 고민해봐야 할 듯.


### ~~volume 바닥에 이미지 머티리얼 적용 기능 구현~~
- [x] 이미지 추가하는 버튼 구현
- [x] 버튼 클릭하면 이미지 추가하는 ui 띄우기
- [x] 이미지 선택하면, 구현해놓은 함수로 바닥에 material 적용
- [x] 변경 내용 분석하고 PR 작성하기

**버튼을 통해 floor에 적용할 이미지를 등록**
1. 버튼을 클릭하면 DropDockOverlayView가 나타남.
2. DropDockOverlayView에서 원하는 이미지를 추가.
	1. 추가된 이미지는 library에 추가된다.
	2. 해당 이미지의 AssetID를 floorImage 변수에 등록함.
3. 추가된 이미지를 floor에 material로 적용한다.

**floor를 생성할 때**
1. floor를 생성할 때, floorImage변수를 확인한다.
	1. floorImage변수에 이미지가 추가되어있는 경우 해당 이미지를 floor에 material로 적용한다.
	2. floorImage변수가 비어있는 경우 기본 material을 floor에 적용한다.
	   

#### 이슈
**Immersive에서 Alert안나오는 현상 해결 필요**

**25%확률로 attachment버튼 클릭 안되는 버그 해결**

**이미지 적용하면 바로 바닥이 바로 업데이트가 안됨. 나갔다 들어와야 바뀌어있음.**

#### 플로우 개선 필요한 부분
**문제점**
- 이미 라이브러리에서 이미지를 추가할 수 있는데 + 버튼을 통해 이미지 추가 UI를 중복으로 띄울 이유가 없음.
- 한 번 이미지를 선택하면 기본 재질로 돌아가지 못함
- 라이브러리에 추가한 이미지를 배경 이미지로 추가할 수 없음

**개선 사항**
- 라이브러리에서 이미지 옆 ...을 클릭하거나 or 꾹 누르면 "해당 이미지를 바닥 이미지로 설정"이 나온다.
- 적용된 이미지는 우측 상단에 심볼이 추가되어 확인할 수 있다.
- 해당 이미지를 다시 꾹 누르면 "바닥 이미지에서 제거"표시가 되고 기본 재질로 돌아갈 수 있음.


### ~~생성하기 단계 삭제~~
- [x] GroundSize 관련 코드 삭제
	- [x] NavigationView 삭제
	- [x] enum 삭제
	- [x] ProjectModel에서 삭제
- [x] RoomType 관련 코드 삭제
	- [x] NavigationView 삭제
	- [x] enum 삭제
	- [x] ProjectModel에서 삭제

**프로젝트 리스트 뷰에서 라이브러리 뷰로 이동하는 방법**
`MainContentVIew`에서 `if selectedProject != nil`이면, LibraryVIew 열기.


### ~~Volume Resize~~
#### 이슈
volume 창 크기 조절을 하면, 콘텐츠의 크기가 조정되지 않고 위치만 조정됨.
**원인**: volume resize 시 RealityKit 내부 Entity에 scale 변환이 누락.



### ~~Immersive객체 volume에서 보이지 않는 문제 해결~~

**ImageAsset 생성 과정**
`SceneViewModel+EntityManagement.swift`
*updateEntities* -> *updateOrCreateEntities* -> *createAndAddEntity*
에서 image 에셋 생성.




### ~~AppState 중앙화 관리~~

`ProjectListViewModel.swift`

**기존 프로젝트 선택시 로직**
1. `selectProject(project: Project)` 실행 -> `appModel.selectedProject`에 등록.
2. 해당 프로젝트를 인자로 `loadSceneModel(project)`실행 -> `appModel.selectedScene`에 등록.

**변경 후 프로젝트 선택시 로직**
1. `selectProject(project: Project)`에서 `let sceneModel = loadSceneModel(project)`을 통해서 sceneModel을 받아와서 `appModel.selectProject(project, scene: sceneModel)`으로 한 번에 등록.


``
**SceneViewIdentifier** 수정 필요. 해당 값이 바뀌면 씬이 전체 재생성되어서 비효율적.



### volume, immersive 동기화
rootEntity를 전역으로 관리 ?
- [x] immersive상태에서 ovject의 높이가 너무 낮음. immersive상태에서 rootEntity사이즈를 1이 아니라 더 큰 사이즈로 조절해서 비율을 맞춰야 할듯.


`sceneConfig`에서 모든 것을 관리
- 볼륨일때 rootEntity size
- immersive일 때 rootEntity size
- immersive일 때 scale Size

#### 이슈
**update 클로저가 실행되어야 objecte들이 올바른 위치로 이동**
update클로저에서 `updateScene`이 호출되어야 object들이 올바르게 위치함.

그런데 make 클로저에 updateScene을 추가하면 문제가 해결되지 않을까 ?
-> volumeresize때문이라지만, immersive에서도 동일한 문제가 생김.


### object 벽 뒤로 이동하지 못하게
- [ ] object일정 높이 이하로 이동 불가능
- [ ] floor영역 기준으로 object 이동하지 못하게 `EntityDragGesture`제한 추가

`EntityDragGesture` 의 `minY`, `minX`값을 조절하면 일정 영역 밖으로 드래그하지 못하게 제한할 수 있음

### ~~"x" 버튼으로 윈도우 닫기 감지~~
x버튼으로 창을 닫으면, 해당 scene이 사라지는게 아니라, `UIWindowScene.activationState`값이 `.background`로 변경된다.

해당 값이 변경되면, 특정 함수를 실행하는 extension이나 함수를 만들어서 `onDisAppear` 대용으로 사용.



## 이슈
### ~~Navigation 배경 중복~~
`Navigation`을 통해 화면을 이동하면, window가 navigationBar영역에서 겹쳐보이는 현상.
navigation방식이 문제가 아니라, 각 화면마다 `glassBackgroundEffect()`를 추가하여 배경이 겹치게 나오는 현상이였음...


### ~~TextureResource 관련~~
`TextureResource.load`는 동기적으로 작동하는 레거시 코드임.
해당 코드는 메인 스레드에서 실행되어 종료될때까지 메인 스레드를 멈춤으로써 다른 UI작업을 진행하지 못하게 함으로, `await TextureResource()`로 변경하여 사용하기

#### 텍스처 양면
`material.faceCulling`값이 기본적으로 `.back`으로 되어있어, 성능 향상을 위해 뒷면 렌더링을 안함. 이걸 `.none`값으로 바꿔주면 plane에서 뒷면도 렌더링됨.


### immersive에서 사진 밖으로 배치시 앱 강제종료

`PreviewApplication API`에서 Windowed Quick Look을 자동으로 실행해서, 다른 앱이 실행됐다고 판단하여 immersive해제되고 앱에 문제가 생김.

**Windowed Quick Look**
![[Pasted image 20251119210811.png]]


### SceneRealityView가 너무 자주 업데이트됨
설계 단계에서 SceneRealityView를 새로고침시키는 조건들을 명확히 지정해두고 설계해야 함.
현재는 state된 값들이 너무 많아 동작을 할때마다 새로고침되고 update클로저 부분이 재실행됨.

**RealityKit** Entity는 swiftUI와 선언적 렌더링 사이클과 독립적으로 작동하여 Entity의 이동이 즉시 반영됨.
**Entity의 프로퍼티 변경은 RealityKit 렌더링 엔진에 의해 자동으로 화면에 반영**

자동 저장 또한 update클로저에서 매번 씬을 update하면서 저장할 것이 아니라, 해당 씬을 나갈 때만 트리거해서 씬이 저장해주면 됨. 그럼 켤 때 읽기 1번, 끌 때 쓰기 1번으로 해결 가능함.


### 잠금 해제 비정상적으로 작동
`issue #236`

두 가지 접근으로 해결.
- 잠금 해제 상태값이 race condition발생하는 문제 해결
- 잠금 해제 progress가 100%되어도 잠금 해제 안되는 문제 해결

