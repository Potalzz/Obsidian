## FCM(Firebase Cloud Messaging)
>무료로 메시지를 안정적으로 전송할 수 있는 교차 플랫폼 메시징 솔루션.

### FCM이 무엇인가 ?
- **FCM**은 **Firebase Cloud Messaging**의 약자로, 무료로 메시지를 안정적으로 전송할 수 있는 교차 플랫폼 메시징 솔루션이다.
- 모든 사용자에게 알림 메세지를 전송할 수도 있고, 그룹을 지어 메시지를 전송할 수도 있다.
- Firebase의 서비스는 요금 정책에 따라, 이용할 수 있는 범위가 다르지만 FCM은 요금 정책에 구분 없이 무료로 사용하는 것이 가능하다.

### 왜 FCM을 사용해서 Push 메시지를 보낼까 ?
>FCM은 교차 플랫폼 메시지 솔루션이기 때문에, FCM을 이용해서 개발을 진행하면, iOS, Android, Web 등의 플랫폼에 종속되지 않고 Push 메시지를 전송할 수 있다.

또한, 메시지를 전달함에 있어서 클라우드 메시징 서버를 사용하지 않으면 어플리케이션 서버에서 메시지를 전달받기 때문에 실시간으로 메시지를 전달받기 위해서는 실시간으로 서버에 계속 접속해 있어야 한다. 이러한 경우 많은 배터리와 네트워크 사용으로 문제가 발생할 수 있다.

 **클라우드 메시징 서비스**를 이용하면, 클라우드 메시징 서버를 중간에 둠으로써, 사용자는 낮은 배터리와 네트워크의 사용만으로도 메시지를 실시간으로 송수신 처리할 수 있다.



### FCM의 주요 특징

#### 메시지 타입
>FCM의 메시지 타입은 **알림 메시지**와 **데이터 메시지**로 구분할 수 있다.

일반적으로 알림 메시지와 데이터 메시지를 같이 혼용해서 사용한다.
- `Ex)` 휴대폰 **푸시 알림 메시지는 알림 메시지를 이용**하고, 알림 메시지를 클릭 했을 때 앱 내 특정 페이지로 이동이나, 어떠한 액션은 데이터 메시지를 통해서 이뤄진다.

| 메시지 유형      | 전달 경로          | 처리 주체        | 설명                                                   |
| ----------- | -------------- | ------------ | ---------------------------------------------------- |
| **알림 메시지**  | FCM → OS → 사용자 | **운영체제(OS)** | 메시지를 자동으로 알림 형태로 표시함. 앱이 꺼져 있어도 가능                   |
| **데이터 메시지** | FCM → 앱 직접 처리  | **앱 코드**     | 알림 표시 여부나 행동은 앱이 직접 처리. 앱이 열려 있어야 함 (백그라운드 또는 포그라운드) |

**알림 메시지 예시**
- 앱 상태와 무관하게 사용자에게 알림을 보여주고 싶을 때
- `Ex)` 공동구매 앱에서 새 모집글 등록 시

**데이터 메시지 예시**
- 앱 내에서 커스텀 동작이나 UI 처리를 해야 할 때
- `Ex)`실시간 참여자 수 업데이트, 채팅, 이벤트 처리 등


#### 타겟팅
>**단일 기기**, **기기 그룹**, **주제를 구독한 기기** **3가지 방식**으로 클라이언트 앱에 메시지를 배포할 수 있다.

| 종류    | 대상수   | 설명            |
| ----- | ----- | ------------- |
| 단일 기기 | 1개    | 하나의 기기(앱 기준)  |
| 기기 그룹 | 20개   | 알림 키에 허용되는 그룹 |
| 주제 구독 | 1000개 | 등록 토큰에 구독된 기기 |

**클라이언트 앱에서 메시지 전송**
- FCM을 이용하면 앱 서버에서 클라이언트 앱으로 다운 스트림 메세지를 보낼 수 있을 뿐만 아니라, 클라이언트 앱에서 앱 서버로도 업 스트림 메세지를 보낼 수 있다
	
- 하지만 클라이언트 앱에서 앱 서버로 업 스트림 메세지를 보내기 위해서는 선행 조건이 필요하다. 그 부분은 밑에서 설명한다

#### FCM의 동작 원리
>크게 송신자, FCM Backend Server, 수신자로 구분한다.
>![[Pasted image 20250529213944.png]]
>[FCM 공식 문서](https://firebase.google.com/docs/cloud-messaging?hl=ko)_

송신자는 주로 앱 서버, HTTP 프로토콜을 사용하는 서버, Firebase Console GUI 등이 될 수 있고, 수신자는 우리가 흔히 사용하는 iOS 또는 Android 운영체제를 사용하는 모바일 기기가 될 수 있다.
    
FCM Backend 서버는 실질적으로 앱 서버에서 요청을 받아서 메세지를 처리하는 서버에 해당된다.
	
FCM 클라우드 메시지의 흐름
- HTTP 프로토콜을 사용할 경우, FCM 클라우드 메시지가 처리되는 과정을 그림으로 나타내보면 다음과 같다.

![[Pasted image 20250529214618.png]]
>[FCM 구조 관련 참고 블로그](https://zeany.net/31?category=666373)

- 앱 서버에서 FCM Backend 서버에 클라이언트 앱에 보내고자 하는 메세지를 담은 정보와, 서버의 인증 정보 클라이언트의 토큰을 담아서 HTTP POST를 요청을 보낸다.
        
    - 요청을 받은 FCM Backend 서버는 요청을 통해 받은 메시지의 이상 유무에 따라 앱 서버에 적절한 응답을 보낸다.
        
    - 이후 FCM Backend 서버에서 여러가지(우선 순위, 클라이언트 앱과의 통신 가능 여부 등)을 고려하여 매세지를 클라이언트 앱에 보낸다.
        
    - 클라이언트 앱에서는 받은 메세지를 적절하게 처리하고 응답 메세지를 FCM Backend 서버로 보내게 된다.
        
    - 요약하면, 앱 서버에서 FCM Backend 서버에 메시지 요청을 보내고, FCM Backend 서버는 사용자 기기에서 실행되는 클라이언트 앱에 메시지를 보내게 된다.
        
- 한 마디로 제대로 된 메시지만 만들어 주면 그것을 실제 기기로 전달하는 것은 FCM Backend에서 처리해줄 것이란 얘기다.
    
- 단, 위의 플로우 대로 메시지를 전송하려면 반드시 선행되어야 하는 작업이 있는데, 당연하겠지만 메시지를 수신할 클라이언트는 자신의 정보를 FCM Backend 서버에 등록해야 한다는 점이다.
    
    - 클라이언트는 자신의 정보(토픽, 디바이스 정보)를 FCM Backend 서버에 등록해야 한다.
        
    - 메시지를 전송할 주체(앱 서버)는 등록된 정보를 획득해야 하며, 해당 정보로 다운 스트림 메시지를 전송한다.


## Firebase


**SQL, NoSQL, Firebase, Firestore 각각의 개념**

| 항목    | SQL               | NoSQL            | Firebase             | Firestore            |
| ----- | ----------------- | ---------------- | -------------------- | -------------------- |
| 무엇?   | 관계형 DB 언어         | 비관계형 DB          | 구글 제공 백엔드 서비스        | Firebase 안의 NoSQL DB |
| 저장 방식 | 표 (행, 열)          | 문서, 키-값, 그래프     | 여러 서비스 통합 플랫폼        | 문서 + 컬렉션 (NoSQL)     |
| 예시    | MySQL, PostgreSQL | MongoDB, Redis   | Firebase Auth, FCM 등 | Cloud Firestore      |
| 특징    | 강력한 쿼리, 데이터 정확성   | 유연한 구조, 빠른 처리    | 서버 없이 앱 만들기          | 실시간 동기화, Firebase 연동 |
| 단점    | 유연성 부족, 스키마 고정    | 복잡 관계 어렵, 무결성 약함 | 커스텀 서버 많아지면 한계       | 복잡 쿼리·대량 데이터에 주의     |


## 앱 개발

### Firebase에서 데이터 받아오기

**파티 상세화면은 어떻게 들어갈까 ?**
1. 파티 목록에서 파티를 클릭한다.
2. 해당 파티의 ID를 파티 상세 viewModel에 전달해서 해당 파티의 view를 띄운다.

#### PartyDetailView

##### 필요한 기능들

**파티 데이터 관리**
	
 - [ ] 파티 정보 가져오기
 - [ ] 파티 정보 수정하기
 - [ ] 조회수 반영

**파티장 관련**
	
 - [ ] 파티에 속해있는 유저 내보내기
 - [ ] 참여 신청 유저 수락/거절 하기
 - [ ] 파티 정보 수정하기
 - [ ] 파티 상태 변경하기 (마감, 공구 종료, 모집 재개)

 **파티원 관련**
	 
 - [ ] 파티 탈퇴하기

**공통 유저 관련**
	
 - [ ] 댓글 달기
 - [ ] 파티 참여 신청
 - [ ] 파티 참여 신청 취소
 - [ ] 관심 파티 설정

**파티 관련 기능**
	
- [ ] 좋아요 수 반영하기
- [ ] 댓글/좋아요 수 계산
- [ ] 현재 유저 정보 가져오기
- [ ] 현재 유저가 파티에서 어떤 상태인지(파티장,파티원,참여 신청중, 일반유저)
- [ ] 파티 참여 인원 충족시 자동 마감
- [ ] 파티 참여 신청시 버튼 변경(참여 취소)


##### 📋 주요 기능

1. **데이터 관리**
    - Firebase에서 파티 정보 로드/업데이트
    - 실시간 데이터 동기화
    - 에러 처리 및 로딩 상태 관리
2. **사용자 권한 관리**
    - 호스트/참여자/대기자 상태 구분
    - 권한별 다른 UI/기능 제공
3. **파티 액션**
    - 참여 신청/취소/떠나기
    - 멤버 승인/거절/내보내기
    - 파티 마감
4. **댓글 시스템**
    - 댓글 추가/표시
    - 실시간 댓글 수 업데이트

##### 🔧 기술적 특징

- **@MainActor**: UI 업데이트 스레드 안전성 보장
- **@Published**: SwiftUI 반응형 업데이트
- **async/await**: 현대적 비동기 처리
- **Computed Properties**: 복잡한 상태 로직 단순화
- **Error Handling**: 사용자 친화적 에러 관리

### Qustion

**파티 일정 부분이 업데이트 될 때마다 모두 update를 통해서 필드 전체를 업데이트 하는이유**
	업데이트가 많이 발생되지 않아서 비용적 리스크가 적기도 하고, 문자열로 전달시 필드에 실제로 있는지 일일이 확인하기가 어렵기 때문에 에러가 발생할 확률이 높다. 그러려면 모든 필드를 protocol과 **CollectionType** `enum`을 통해서 업데이트 해주어야 하는데, 너무 번거롭기 때문?
	
	그럼 실무에서는 어떻게 할까 ? field를 일일이 타입을 지정해줘서 확인하나 ?

